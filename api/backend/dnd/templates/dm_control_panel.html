{% extends "base.html" %}

{% block title %}DM Control Panel{% endblock %}

{% block content %}
    <h1>DM Control Panel</h1>
    <h2>Send Message</h2>
    <form id="messageForm">
        <label for="targetPlayer">Send to:</label>
        <select id="targetPlayer">
            <option value="all">All Players</option>
            {% for player in players %}
            <option value="{{ player.username }}">{{ player.username }}</option>
            {% endfor %}
        </select>

        <label for="messageContent">Message:</label>
        <input type="text" id="messageContent" placeholder="Enter message">
        <button type="submit">Send</button>
    </form>
    <h2>Select Artwork to Display</h2>
    <form id="artworkForm">
        <select name="artwork">
            {% for artwork in artworks %}
                <option value="{{ artwork.id }}">{{ artwork.title }}</option>
            {% endfor %}
        </select>
        <label>Target Player:</label>
        <select name="player">
            <option value="">All Players</option>
            {% for player in players %}
                <option value="{{ player.id }}">{{ player.username }}</option>
            {% endfor %}
        </select>
        <button type="submit">Display Artwork</button>
    </form>
{% endblock %}

{% block scripts %}
<script>
    const dmSocket = new WebSocket(
        "ws://" + window.location.host + "/ws/dm/"
    );

    dmSocket.onopen = function(e) {
        console.log("DM Websocket connected");
    };

    dmSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log("Received message from server:", data.message);
    }

    function sendMessage() {
        const targetPlayer = document.getElementById("targetPlayer").value;
        const messageInput = document.getElementById("messageContent");
        const messageContent = messageInput.value;
        if (dmSocket.readyState === WebSocket.OPEN) {
            dmSocket.send(JSON.stringify({
                "target": targetPlayer,
                "message": messageContent
            }));
            messageInput.value = "";
        } else {
            console.error("WebSocket connection is not open.");
        }
    }

    document.getElementById("messageForm").addEventListener("submit", function(event) {
        event.preventDefault();
        sendMessage();
    });
</script>
{% endblock %}

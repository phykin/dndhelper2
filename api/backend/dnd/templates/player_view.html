{% extends "base.html" %}
{% load static %}
{% load tz %}

{% block title %}Player View{% endblock %}

{% block content%}
    <h1>Player View</h1>
    
    <div id="artworkDisplay">
        {% if current_artwork %}
        <h2>The DM has selected an artwork for you:</h2>
        <img src="/artwork/{{ current_artwork.filename }}" alt="{{ current_artwork.title }}" style="max-width: 500px;"></img>
        {% else %}
        <p>No artwork selected</p>
        {% endif %}
    </div>
    {% if not current_artwork %}
    <h2>Available Artworks</h2>
    <div id="availableArtworks">
        {% for artwork in available_artworks %}
        <div>
            <button onclick="selectArtwork('{{ artwork.id }}', '{{ artwork.title }}', '{{ artwork.filename}}')">
                View {{ artwork.title }}
            </button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <h2>Messages from DM</h2>
    <div id="messagesDisplay">
        {% for message in messages %}
        <p>{{ message.timestamp | localtime | date:"d.m.Y H:i:s T" }} - {{ message.content }}</p>
        {% endfor %}
    </div>
{% endblock %}

{% block scripts %}
<script>
    var currentArtworkId = {% if current_artwork %}{{ current_artwork.id }}{% else %}null{% endif %};

    const playerSocket = new WebSocket(
        "ws://" + window.location.host + "/ws/player/"
    );

    playerSocket.onopen = function(e) {
        console.log("Player WebSocket connected");
    };

    playerSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log("Message received", data);

        if (data.type === "broadcast_message") {
            const messagesDisplay = document.getElementById("messagesDisplay");
            const newMessageElement = document.createElement("p");
            newMessageElement.textContent = `${data.timestamp} - ${data.message}`;
            messagesDisplay.prepend(newMessageElement);
        } else if (data.type === "force_artwork") {
            const availableArtworks = document.getElementById("availableArtworks");
            if (availableArtworks) {
                availableArtworks.style.display = 'none';
            }
            
            const artworkDisplay = document.getElementById("artworkDisplay");
            artworkDisplay.innerHTML = `
                <h2>The DM has selected an artwork for you:</h2>
                <img src="/artwork/${data.filename}" alt="${data.title}" style="max-width: 500px;">
            `;
            currentArtworkId = data.artwork_id;
        } else if (data.type === "remove_force_artwork") {
            const availableArtworks = document.getElementById("availableArtworks");
            if (availableArtworks) {
                availableArtworks.style.display = 'block';
            }
            const artworkDisplay = document.getElementById("artworkDisplay");
            artworkDisplay.innerHTML = `<p>No artwork selected.</p>`;
            currentArtworkId = null;
            location.reload();
        } else if (data.type === "remove_artwork") {
            if (window.currentArtworkId == data.artwork_id) {
                const artworkDisplay = document.getElementById("artworkDisplay");
                artworkDisplay.innerHTML = '<p>No artwork selected.</p>'
                currentArtworkId = null;
                location.reload();
            }
        }
    }

    function selectArtwork(artworkId, title, filename) {
        if (currentArtworkId !== null) {
            alert("You cannot change the artwork while the DM has selected one for you.");
            return;
        }
        const artworkDisplay = document.getElementById("artworkDisplay");
        artworkDisplay.innerHTML = `
            <h2>Current Artwork: ${title}</h2>
            <img src="/artwork/${filename}" alt="${title}" style="max-width: 500px;">
        `;
        currentArtworkId = artworkId;
    }
</script>
{% endblock %}